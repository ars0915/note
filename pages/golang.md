public:: true

- ## goroutine GMP
	- **åŸºæœ¬æ¦‚å¿µè¦èƒ½èªªå‡ºä¾†ï¼š**
		- **G (Goroutine)**ï¼šç”¨æˆ¶æ…‹çš„è¼•é‡ç´šåŸ·è¡Œç·’
		- **M (Machine)**ï¼šOS åŸ·è¡Œç·’
		- **P (Processor)**ï¼šé‚è¼¯è™•ç†å™¨ï¼ŒæŒæœ‰ G çš„ä½‡åˆ—
	- **æ ¸å¿ƒå„ªå‹¢**ï¼šM:N èª¿åº¦æ¨¡å‹ï¼Œä¸€å€‹ M å¯ä»¥åŸ·è¡Œå¤šå€‹ G
- ## Goroutine Leak æ€éº¼é¿å…ï¼Ÿ
	- channel æ²’é—œé–‰
	- context æ²’å–æ¶ˆ
	- æ­»é–æƒ…æ³
- ## Channel çš„ä½¿ç”¨èˆ‡åŸç†
  id:: 8ca97253-f228-4ce0-8605-ca9e51f24c3d
	- buffered vs unbuffered
	- close çš„æ™‚æ©Ÿ
	- select çš„ä½¿ç”¨
	- ### è¶…æ™‚æ§åˆ¶
		- time.After
		  ```go
		  func doBadthing(done chan bool) {
		  	time.Sleep(time.Second)
		  	done <- true
		  }
		  
		  // æˆ–æ˜¯ä½¿ç”¨ select å°è¯•å‘ä¿¡é“ done å‘é€ä¿¡å·ï¼Œå¦‚æœå‘é€å¤±è´¥ï¼Œåˆ™è¯´æ˜ç¼ºå°‘æ¥æ”¶è€…(receiver)ï¼Œå³è¶…æ—¶äº†ï¼Œé‚£ä¹ˆç›´æ¥é€€å‡ºå³å¯ã€‚
		  func doGoodthing(done chan bool) {
		  	time.Sleep(time.Second)
		  	select {
		  	case done <- true:
		  	default:
		  		return
		  	}
		  }
		  
		  func timeout(f func(chan bool)) error {
		  	done := make(chan bool, 1) // åˆ›å»ºchannel done æ—¶ï¼Œç¼“å†²åŒºè®¾ç½®ä¸º 1ï¼Œå³ä½¿æ²¡æœ‰æ¥æ”¶æ–¹ï¼Œå‘é€æ–¹ä¹Ÿä¸ä¼šå‘ç”Ÿé˜»å¡ã€‚
		  	go f(done)
		  	select {
		  	case <-done:
		  		fmt.Println("done")
		  		return nil
		  	case <-time.After(time.Millisecond):
		  		return fmt.Errorf("timeout")
		  	}
		  }
		  
		  // timeout(doBadthing)
		  ```
		  å¦‚æœ done æ˜¯ä¸€ä¸ªæ— ç¼“å†²åŒºçš„ channelï¼Œå¦‚æœæ²¡æœ‰è¶…æ—¶ï¼Œ`doBadthing`Â ä¸­ä¼šå‘ done å‘é€ä¿¡å·ï¼Œ`select`Â ä¸­ä¼šæ¥æ”¶ done çš„ä¿¡å·ï¼Œå› æ­¤Â `doBadthing`Â èƒ½å¤Ÿæ­£å¸¸é€€å‡ºï¼Œå­åç¨‹ä¹Ÿèƒ½å¤Ÿæ­£å¸¸é€€å‡ºã€‚
		  ä½†æ˜¯ï¼Œå½“è¶…æ—¶å‘ç”Ÿæ—¶ï¼Œselect æ¥æ”¶åˆ°Â `time.After`Â çš„è¶…æ—¶ä¿¡å·å°±è¿”å›äº†ï¼Œ`done`Â æ²¡æœ‰äº†æ¥æ”¶æ–¹(receiver)ï¼Œè€ŒÂ `doBadthing`Â åœ¨æ‰§è¡Œ 1s åå‘Â `done`Â å‘é€ä¿¡å·ï¼Œç”±äºæ²¡æœ‰æ¥æ”¶è€…ä¸”æ— ç¼“å­˜åŒºï¼Œå‘é€è€…(sender)ä¼šä¸€ç›´é˜»å¡ï¼Œå¯¼è‡´åç¨‹ä¸èƒ½é€€å‡ºã€‚
	- ### å„ªé›…é—œé–‰
		- ### channel çš„ä¸‰ç§çŠ¶æ€å’Œä¸‰ç§æ“ä½œç»“æœ
		  
		  | æ“ä½œ | ç©ºå€¼(nil) | éç©ºå·²å…³é—­ | éç©ºæœªå…³é—­ |
		  | ---- | ---- | ---- |
		  | å…³é—­ | panic | panic | æˆåŠŸå…³é—­ |
		  | å‘é€æ•°æ® | æ°¸ä¹…é˜»å¡ | panic | é˜»å¡æˆ–æˆåŠŸå‘é€ |
		  | æ¥æ”¶æ•°æ® | æ°¸ä¹…é˜»å¡ | æ°¸ä¸é˜»å¡ | é˜»å¡æˆ–è€…æˆåŠŸæ¥æ”¶ |
		- ```go
		  func doCheckClose(taskCh chan int) {
		  	for {
		  		select {
		  		case t, beforeClosed := <-taskCh:
		  			if !beforeClosed {
		  				// beforeClosed ä¸º false è¡¨ç¤ºä¿¡é“å·²è¢«å…³é—­ã€‚è‹¥å…³é—­ï¼Œåˆ™ä¸å†é˜»å¡ç­‰å¾…ï¼Œç›´æ¥è¿”å›ï¼Œå¯¹åº”çš„åç¨‹éšä¹‹é€€å‡ºã€‚
		  				fmt.Println("taskCh has been closed")
		  				return
		  			}
		  			time.Sleep(time.Millisecond)
		  			fmt.Printf("task %d is done\n", t)
		  		}
		  	}
		  }
		  
		  func sendTasksCheckClose() {
		  	taskCh := make(chan int, 10)
		  	go doCheckClose(taskCh)
		  	for i := 0; i < 1000; i++ {
		  		taskCh <- i
		  	}
		  	// sendTasks å‡½æ•°ä¸­ï¼Œä»»åŠ¡å‘é€ç»“æŸä¹‹åï¼Œä½¿ç”¨ close(taskCh) å°† channel taskCh å…³é—­ã€‚
		  	close(taskCh)
		  }
		  
		  func TestDoCheckClose(t *testing.T) {
		  	t.Log(runtime.NumGoroutine())
		  	sendTasksCheckClose()
		  	time.Sleep(time.Second)
		  	runtime.GC()
		  	t.Log(runtime.NumGoroutine())
		  }
		  ```
	- ### é€šé“å…³é—­åŸåˆ™
		- å¦‚æœ channel å·²ç»è¢«å…³é—­ï¼Œå†æ¬¡å…³é—­ä¼šäº§ç”Ÿ panicï¼Œè¿™æ—¶é€šè¿‡ recover ä½¿ç¨‹åºæ¢å¤æ­£å¸¸ã€‚
		- ç¤¼è²Œçš„æ–¹å¼
			- ä½¿ç”¨ sync.Once æˆ–äº’æ–¥é”(sync.Mutex)ç¡®ä¿ channel åªè¢«å…³é—­ä¸€æ¬¡ã€‚
		- ä¼˜é›…çš„æ–¹å¼
			- æƒ…å½¢ä¸€ï¼šMä¸ªæ¥æ”¶è€…å’Œä¸€ä¸ªå‘é€è€…ï¼Œå‘é€è€…é€šè¿‡å…³é—­ç”¨æ¥ä¼ è¾“æ•°æ®çš„é€šé“æ¥ä¼ é€’å‘é€ç»“æŸä¿¡å·ã€‚
			- æƒ…å½¢äºŒï¼šä¸€ä¸ªæ¥æ”¶è€…å’ŒNä¸ªå‘é€è€…ï¼Œæ­¤å”¯ä¸€æ¥æ”¶è€…é€šè¿‡å…³é—­ä¸€ä¸ªé¢å¤–çš„ä¿¡å·é€šé“æ¥é€šçŸ¥å‘é€è€…ä¸è¦å†å‘é€æ•°æ®äº†ã€‚
			- æƒ…å½¢ä¸‰ï¼šMä¸ªæ¥æ”¶è€…å’ŒNä¸ªå‘é€è€…ï¼Œå®ƒä»¬ä¸­çš„ä»»ä½•åç¨‹éƒ½å¯ä»¥è®©ä¸€ä¸ªä¸­é—´è°ƒè§£åç¨‹å¸®å¿™å‘å‡ºåœæ­¢æ•°æ®ä¼ é€çš„ä¿¡å·ã€‚
- ## Context çš„å‚³éèˆ‡å–æ¶ˆ
  Context æ˜¯ Go ç”¨ä¾†åœ¨ goroutine ä¹‹é–“å‚³é**å–æ¶ˆä¿¡è™Ÿã€è¶…æ™‚æ§åˆ¶ã€æˆªæ­¢æ™‚é–“å’Œè«‹æ±‚ç¯„åœå€¼**çš„æ¨™æº–æ–¹å¼ã€‚
  | åŠŸèƒ½ | ä½¿ç”¨å ´æ™¯ | å‡½æ•¸ |
  | ---- | ---- | ---- |
  | **æ‰‹å‹•å–æ¶ˆ** | ç”¨æˆ¶å–æ¶ˆæ“ä½œã€éŒ¯èª¤æ™‚æå‰çµ‚æ­¢ | WithCancel |
  | **è¶…æ™‚æ§åˆ¶** | API èª¿ç”¨ã€è³‡æ–™åº«æŸ¥è©¢ | WithTimeout |
  | **æˆªæ­¢æ™‚é–“** | éœ€è¦åœ¨ç‰¹å®šæ™‚é–“é»å®Œæˆ | WithDeadline |
  | **å„ªé›…é—œé–‰** | æœå‹™å™¨é—œé–‰ã€æ‰¹è™•ç†å®Œæˆ | é…åˆ signal.Notify |
- ## å¸¸è¦‹ä¸¦ç™¼å•é¡Œ
	- Race condition æ€éº¼ debugï¼Ÿ
	- å¦‚ä½•æ§åˆ¶ goroutine æ•¸é‡ï¼Ÿï¼ˆworker poolï¼‰
- ## panic
	- `recover()` **å¿…é ˆ**åœ¨ `defer` å‡½æ•¸ä¸­å‘¼å«
	  ```go
	  func wrong2() {
	      defer recover() // âŒ ç„¡æ•ˆï¼recover å¿…é ˆåœ¨ã€Œå‡½æ•¸å‘¼å«ã€ä¸­
	      panic("test")
	  }
	  
	  // æ­£ç¢ºå¯«æ³•
	  func correct() {
	      defer func() {
	          recover() // âœ… åœ¨åŒ¿åå‡½æ•¸ä¸­å‘¼å«
	      }()
	      panic("test")
	  }
	  ```
	- panic ç™¼ç”Ÿå¾Œï¼Œç•¶å‰å‡½æ•¸æœƒç«‹å³åœæ­¢ï¼Œé–‹å§‹åŸ·è¡Œ defer æ£§
	- recover è¦è·Ÿ panic åœ¨åŒä¸€å€‹ goroutine æ‰æœƒè¢«è§¸ç™¼
	- å¦‚æœæ²’æœ‰ recoverï¼Œpanic æœƒå‘ä¸Šå‚³æ’­ç›´åˆ°ç¨‹å¼å´©æ½°
	- defer æ˜¯ **LIFOï¼ˆå¾Œé€²å…ˆå‡ºï¼‰** æ£§
	- é©åˆç”¨ panic çš„å ´æ™¯ï¼š
		- **åˆå§‹åŒ–éšæ®µçš„è‡´å‘½éŒ¯èª¤**ï¼ˆå¦‚è¨­å®šæª”è¼‰å…¥å¤±æ•—ï¼‰
		- **ç¨‹å¼è¨­è¨ˆéŒ¯èª¤**ï¼ˆå¦‚é™¤ä»¥é›¶ã€é™£åˆ—è¶Šç•Œï¼‰
		- **ä¸å¯æ¢å¾©çš„éŒ¯èª¤**ï¼ˆå¦‚è¨˜æ†¶é«”åˆ†é…å¤±æ•—ï¼‰
	- ä¸æ‡‰è©²ç”¨ panic çš„å ´æ™¯ï¼š
		- **æ­£å¸¸çš„éŒ¯èª¤è™•ç†**ï¼ˆæ‡‰è©²ç”¨ `error` å›å‚³ï¼‰
		- **å¯é æœŸçš„å¤±æ•—**ï¼ˆå¦‚ç¶²è·¯è«‹æ±‚å¤±æ•—ã€æª”æ¡ˆä¸å­˜åœ¨ï¼‰
		- **æ¥­å‹™é‚è¼¯éŒ¯èª¤**
	- **é¢è©¦æ¨™æº–ç­”æ¡ˆï¼š**
		- "Go æå€¡ç”¨ error è™•ç†éŒ¯èª¤ï¼Œpanic æ‡‰è©²åªç”¨åœ¨çœŸæ­£ç„¡æ³•æ¢å¾©çš„ç•°å¸¸æƒ…æ³ã€‚åœ¨å‡½å¼åº«é–‹ç™¼ä¸­ï¼Œå¹¾ä¹ä¸æ‡‰è©²è®“ panic å‚³æ’­çµ¦å‘¼å«è€…ï¼Œæ‡‰è©² recover å¾Œè½‰æˆ error å›å‚³ã€‚"
- ## channel
	- Unbuffered Channel
		- åœ¨æ¯æ¬¡è¦å‚³é€æˆ–æ¥æ”¶å‰éƒ½å¿…éœ€é€²è¡Œç­‰å¾…
		  å°æ–¼ä¸€å€‹æ²’æœ‰ buffer çš„ channel ï¼Œchannel ä¸Šä¸€æ¬¡åªèƒ½æœ‰ä¸€å€‹å€¼ï¼Œå‰ä¸€å€‹å‚³å®Œï¼Œæ‰èƒ½å‚³ä¸‹ä¸€å€‹ï¼Œä¸èƒ½å…è¨±ä¸€æ¬¡ä¸Šå‚³è¶…éä¸€å€‹
	- buffered Channel
		- å¦‚æœæ˜¯æœ‰ buffer çš„ channel é‚£éº¼å°±Â **ä¸å¿…åœ¨æ„å°æ–¹æ˜¯å¦æ¥æ”¶åˆ°**Â ï¼Œåªè¦åœ¨ä»¥æ˜¯å¦ä»æœ‰è¶³å¤ çš„ç·©å……ç©ºé–“ï¼Œå¦‚æœæ²’æœ‰ç©ºé–“äº†æ‰æœƒé€²è¡Œç­‰å¾…ã€‚
	- æ¥æ”¶ä¸ç¢ºå®šå€‹æ•¸çš„ channel
		- å› æ­¤å¯ä»¥åˆ©ç”¨Â `for + range`Â ä¾†æ¥æ”¶ channel ä¸Šçš„å€¼ï¼Œä½†æ˜¯è¦æ³¨æ„ä¸€é»ï¼Œå‚³é€æœ€å¾Œä¸€å€‹å€¼å¾Œå¿…éœ€åˆ©ç”¨Â `close()`Â å°‡ channel é—œé–‰ï¼Œgolang æ‰çŸ¥é“é€™æ˜¯æœ€å¾Œä¸€å€‹å€¼
- ## array
	- array çš„é•·åº¦æ˜¯å›ºå®šçš„ï¼Œå…©å€‹é•·åº¦ä¸åŒçš„ array ä¸èƒ½äº’ç›¸è³¦å€¼
	- C èªè¨€çš„ array æ˜¯æŒ‡å‘ç¬¬ä¸€å€‹å…ƒç´ çš„æŒ‡é‡ï¼Œ Go ä¸æ˜¯ã€‚**Go çš„ array è¢«å‚³éæ™‚æ˜¯è¤‡è£½ä¸€å€‹ã€‚**
	  ```go
	  a := [...]int{1, 2, 3}
	  b := a
	  a[0] = 100
	  fmt.Println(a, b) // [100 2 3] [1 2 3]
	  ```
- ## slice
	- ### struct
	  ```go
	  struct {
	      ptr *[]T
	      len int
	      cap int
	  }
	  ```
	- æ–°å¢å…ƒç´ åˆ° slice æ™‚, å¦‚æœè¶…éäº† cap çš„å¤§å°, æœƒåˆ†é…å…§å­˜ä¾†å¢å¤§ã€‚ç•¶å°æ–¼ 2048 æ™‚æ˜¯ä»¥ 2 çš„å€æ•¸æ–°å¢ã€‚
	- ### slice æ“ä½œä¸è¤‡è£½å…ƒç´ 
	  ![image.png](../assets/image_1762429535751_0.png)
	  ```go
	  nums := make([]int, 0, 8)
	  nums = append(nums, 1, 2, 3, 4, 5)
	  nums2 := nums[2:4]
	  printLenCap(nums)  // len: 5, cap: 8 [1 2 3 4 5]
	  printLenCap(nums2) // len: 2, cap: 6 [3 4]
	  
	  nums2 = append(nums2, 50, 60)
	  printLenCap(nums)  // len: 5, cap: 8 [1 2 3 4 50]
	  printLenCap(nums2) // len: 4, cap: 6 [3 4 50 60]
	  ```
		- nums2 æŠŠ nums æ‹¿ä¾†åˆ‡ç‰‡ï¼Œåº•å±¤æŒ‡çš„æ˜¯åŒä¸€å€‹ array
		- nums2 æ–°å¢ 50, 60 å°‡åº•å±¤ [4] çš„ä½ç½®æ”¹æˆ 50ï¼Œ[5] æ”¹æˆ 60
		- å› ç‚º nums å’Œ nums2 æ˜¯æŒ‡å‘åŒä¸€å€‹ array æ‰€ä»¥ä¹Ÿè¢«æ”¹äº†å€¼
	- ### slice æ“ä½œ
		- **Copy**
		  ![image.png](../assets/image_1762429852485_0.png)
		- **append**
		  ![image.png](../assets/image_1762429867927_0.png)
		  åˆ‡ç‰‡æœ‰ä¸‰ä¸ªå±æ€§ï¼ŒæŒ‡é’ˆ(ptr)ã€é•¿åº¦(len) å’Œå®¹é‡(cap)ã€‚append æ—¶æœ‰ä¸¤ç§åœºæ™¯ï¼š
			- å½“ append ä¹‹åçš„é•¿åº¦å°äºç­‰äº capï¼Œå°†ä¼šç›´æ¥åˆ©ç”¨åŸåº•å±‚æ•°ç»„å‰©ä½™çš„ç©ºé—´ã€‚
			- å½“ append åçš„é•¿åº¦å¤§äº cap æ—¶ï¼Œåˆ™ä¼šåˆ†é…ä¸€å—æ›´å¤§çš„åŒºåŸŸæ¥å®¹çº³æ–°çš„åº•å±‚æ•°ç»„ã€‚
			  å› æ­¤ï¼Œä¸ºäº†é¿å…å†…å­˜å‘ç”Ÿæ‹·è´ï¼Œå¦‚æœèƒ½å¤ŸçŸ¥é“æœ€ç»ˆçš„åˆ‡ç‰‡çš„å¤§å°ï¼Œé¢„å…ˆè®¾ç½® cap çš„å€¼èƒ½å¤Ÿè·å¾—æœ€å¥½çš„æ€§èƒ½ã€‚
		- **Delete**
		  ![image.png](../assets/image_1762429942293_0.png)
		  åˆ‡ç‰‡çš„åº•å±‚æ˜¯æ•°ç»„ï¼Œå› æ­¤åˆ é™¤æ„å‘³ç€åé¢çš„å…ƒç´ éœ€è¦é€ä¸ªå‘å‰ç§»ä½ã€‚æ¯æ¬¡åˆ é™¤çš„å¤æ‚åº¦ä¸º O(N)ï¼Œå› æ­¤åˆ‡ç‰‡ä¸åˆé€‚å¤§é‡éšæœºåˆ é™¤çš„åœºæ™¯ï¼Œè¿™ç§åœºæ™¯ä¸‹é€‚åˆä½¿ç”¨é“¾è¡¨ã€‚
		- **Delete(GC)**
		  ![image.png](../assets/image_1762429973856_0.png)
		  åˆ é™¤åï¼Œå°†ç©ºä½™çš„ä½ç½®ç½®ç©ºï¼Œæœ‰åŠ©äºåƒåœ¾å›æ”¶ã€‚
		- **Insert**
		  ![image.png](../assets/image_1762430007707_0.png)
		  insert å’Œ append ç±»ä¼¼ã€‚å³åœ¨æŸä¸ªä½ç½®æ·»åŠ ä¸€ä¸ªå…ƒç´ åï¼Œå°†è¯¥ä½ç½®åé¢çš„å…ƒç´ å† append å›å»ã€‚å¤æ‚åº¦ä¸º O(N)ã€‚å› æ­¤ï¼Œä¸é€‚åˆå¤§é‡éšæœºæ’å…¥çš„åœºæ™¯ã€‚
		- **Filter**
		  ```go
		  n := 0
		  for _, x := range a {
		      if keep(x) {
		          a[n] = x  // æŠŠä¿ç•™çš„å…ƒç´ ç§»åˆ°å‰é¢
		          n++       // n è¨˜éŒ„ä¿ç•™äº†å¹¾å€‹å…ƒç´ 
		      }
		  }
		  a = a[:n]  // é‡æ–°åˆ‡ç‰‡ï¼Œåªä¿ç•™å‰ n å€‹å…ƒç´ 
		  
		  
		  // å‡è¨­åŸå§‹ sliceï¼ša = [1, 2, 3, 4, 5]ï¼Œæˆ‘å€‘è¦ä¿ç•™å¶æ•¸ã€‚
		  // å¾ªç’°å¾Œï¼š
		  // a = [2, 4, 3, 4, 5]  â† æ³¨æ„ï¼é•·åº¦é‚„æ˜¯ 5
		  // n = 2                â† åªæœ‰ 2 å€‹å…ƒç´ ç¬¦åˆæ¢ä»¶
		  //      â†‘  â†‘  â†â”€â”€ é€™äº›æ˜¯èˆŠæ•¸æ“š
		  
		  // åŸ·è¡Œ a = a[:n]
		  a = [2, 4]  // len: 2, èˆŠçš„ [3, 4, 5] è¢«åˆ‡æ‰äº†
		  ```
		  å½“åŸåˆ‡ç‰‡ä¸ä¼šå†è¢«ä½¿ç”¨æ—¶ï¼Œå°±åœ° filter æ–¹å¼æ˜¯æ¯”è¾ƒæ¨èçš„ï¼Œå¯ä»¥èŠ‚çœå†…å­˜ç©ºé—´ã€‚
			- `a = a[:n]` çš„ä½œç”¨ï¼š
				- **æˆªæ–· slice**ï¼Œè®“é•·åº¦è®Šæˆå¯¦éš›ä¿ç•™çš„å…ƒç´ æ•¸é‡
				- **ä¸Ÿæ£„å¾Œé¢çš„èˆŠå…ƒç´ **ï¼Œè®“ slice åªåŒ…å«éæ¿¾å¾Œçš„æ•¸æ“š
				- é€™æ˜¯ä¸€ç¨®**é›¶åˆ†é…ï¼ˆzero allocationï¼‰** çš„é«˜æ•ˆéæ¿¾æ–¹å¼ï¼Œä¸éœ€è¦å‰µå»ºæ–° sliceã€‚
		- **Push**
		  ```go
		  a = append(a, x)
		  ```
		  åœ¨æœ«å°¾è¿½åŠ å…ƒç´ ï¼Œä¸è€ƒè™‘å†…å­˜æ‹·è´çš„æƒ…å†µï¼Œå¤æ‚åº¦ä¸º O(1)ã€‚
		  ![image.png](../assets/image_1762430302016_0.png)
		  åœ¨å¤´éƒ¨è¿½åŠ å…ƒç´ ï¼Œæ—¶é—´å’Œç©ºé—´å¤æ‚åº¦å‡ä¸º O(N)ï¼Œä¸æ¨èã€‚
		- **Pop**
		  ![image.png](../assets/image_1762430334902_0.png)
		  å°¾éƒ¨åˆ é™¤å…ƒç´ ï¼Œå¤æ‚åº¦ O(1)
		  ![image.png](../assets/image_1762430372145_0.png)
		  å¤´éƒ¨åˆ é™¤å…ƒç´ ï¼Œå¦‚æœä½¿ç”¨åˆ‡ç‰‡æ–¹å¼ï¼Œå¤æ‚åº¦ä¸º O(1)ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåº•å±‚æ•°ç»„æ²¡æœ‰å‘ç”Ÿæ”¹å˜ï¼Œç¬¬ 0 ä¸ªä½ç½®çš„å†…å­˜ä»æ—§æ²¡æœ‰é‡Šæ”¾ã€‚å¦‚æœæœ‰å¤§é‡è¿™æ ·çš„æ“ä½œï¼Œå¤´éƒ¨çš„å†…å­˜ä¼šä¸€ç›´è¢«å ç”¨ã€‚
	- ### æ€§èƒ½é™·é˜± å¤§é‡å†…å­˜å¾—ä¸åˆ°é‡Šæ”¾
		- åœ¨å·²æœ‰åˆ‡ç‰‡çš„åŸºç¡€ä¸Šè¿›è¡Œåˆ‡ç‰‡ï¼Œä¸ä¼šåˆ›å»ºæ–°çš„åº•å±‚æ•°ç»„ã€‚å› ä¸ºåŸæ¥çš„åº•å±‚æ•°ç»„æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œå†…å­˜ä¼šä¸€ç›´å ç”¨ï¼Œç›´åˆ°æ²¡æœ‰å˜é‡å¼•ç”¨è¯¥æ•°ç»„ã€‚å› æ­¤å¾ˆå¯èƒ½å‡ºç°è¿™ä¹ˆä¸€ç§æƒ…å†µï¼ŒåŸåˆ‡ç‰‡ç”±å¤§é‡çš„å…ƒç´ æ„æˆï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨åŸåˆ‡ç‰‡çš„åŸºç¡€ä¸Šåˆ‡ç‰‡ï¼Œè™½ç„¶åªä½¿ç”¨äº†å¾ˆå°ä¸€æ®µï¼Œä½†åº•å±‚æ•°ç»„åœ¨å†…å­˜ä¸­ä»ç„¶å æ®äº†å¤§é‡ç©ºé—´ï¼Œå¾—ä¸åˆ°é‡Šæ”¾ã€‚æ¯”è¾ƒæ¨èçš„åšæ³•ï¼Œä½¿ç”¨Â `copy`Â æ›¿ä»£Â `re-slice`ã€‚
		- ```go
		  func lastNumsBySlice(origin []int) []int {
		  	return origin[len(origin)-2:]
		  }
		  
		  func lastNumsByCopy(origin []int) []int {
		  	result := make([]int, 2)
		  	copy(result, origin[len(origin)-2:])
		  	return result
		  }
		  ```
		  `lastNumsBySlice`Â è€—è´¹äº† 100.14 MB å†…å­˜ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç”³è¯·çš„ 100 ä¸ª 1 MB å¤§å°çš„å†…å­˜æ²¡æœ‰è¢«å›æ”¶ã€‚å› ä¸ºåˆ‡ç‰‡è™½ç„¶åªä½¿ç”¨äº†æœ€å 2 ä¸ªå…ƒç´ ï¼Œä½†æ˜¯å› ä¸ºä¸åŸæ¥ 1M çš„åˆ‡ç‰‡å¼•ç”¨äº†ç›¸åŒçš„åº•å±‚æ•°ç»„ï¼Œåº•å±‚æ•°ç»„å¾—ä¸åˆ°é‡Šæ”¾ï¼Œå› æ­¤ï¼Œæœ€ç»ˆ 100 MB çš„å†…å­˜å§‹ç»ˆå¾—ä¸åˆ°é‡Šæ”¾ã€‚è€ŒÂ `lastNumsByCopy`Â ä»…æ¶ˆè€—äº† 3.14 MB çš„å†…å­˜ã€‚è¿™æ˜¯å› ä¸ºï¼Œé€šè¿‡Â `copy`ï¼ŒæŒ‡å‘äº†ä¸€ä¸ªæ–°çš„åº•å±‚æ•°ç»„ï¼Œå½“ origin ä¸å†è¢«å¼•ç”¨åï¼Œå†…å­˜ä¼šè¢«åƒåœ¾å›æ”¶(garbage collector, GC)ã€‚
- ## Go é€²éšé™·é˜±
	- ### string/[]byte è½‰æ›
		- **string å’Œ []byte äº’è½‰æœƒç™¼ç”Ÿè¨˜æ†¶é«”æ‹·è²**ï¼Œåœ¨é«˜æ€§èƒ½å ´æ™¯ä¸‹å¯èƒ½æˆç‚ºç“¶é ¸
		  ```go
		  s := "hello"
		  b := []byte(s)  // âš ï¸ åˆ†é…æ–°è¨˜æ†¶é«”ï¼Œæ‹·è² 5 å€‹å­—ç¯€
		  s2 := string(b) // âš ï¸ åˆåˆ†é…æ–°è¨˜æ†¶é«”ï¼Œå†æ‹·è² 5 å€‹å­—ç¯€
		  ```
		  å› ç‚º string æ˜¯ä¸å¯è®Šçš„ï¼Œ[]byte æ˜¯å¯è®Šçš„
		- é›¶æ‹·è²æŠ€è¡“
			- ä½¿ç”¨ `unsafe` åŒ…ï¼ˆä¸å®‰å…¨ä½†é«˜æ•ˆï¼‰
			- æ¨™æº–åº«çš„é›¶æ‹·è²æ–¹æ¡ˆ
				- `strings.Builder`ï¼ˆæ¨è–¦ï¼‰
				  ```go
				  func concatBuilder(strs []string) string {
				      var builder strings.Builder
				      for _, s := range strs {
				          builder.WriteString(s)  // åªåœ¨å®¹é‡ä¸è¶³æ™‚æ‰æ“´å®¹
				      }
				      return builder.String()  // æœ€å¾Œä¸€æ¬¡è½‰æ›
				  }
				  ```
				- `bytes.Buffer`
				  ```go
				  var buf bytes.Buffer
				  buf.WriteString("hello")
				  buf.WriteByte(' ')
				  buf.WriteString("world")
				  result := buf.String()  // æœ€å¾Œæ‰è½‰æˆ string
				  ```
	- ### for-range é–‰åŒ…é™·é˜±
		- ç¶“å…¸é™·é˜±ï¼ˆGo 1.21 åŠä¹‹å‰ï¼‰
		  ```go
		  func main() {
		      nums := []int{1, 2, 3}
		      var funcs []func()
		      
		      for _, n := range nums {
		          funcs = append(funcs, func() {
		              fmt.Println(n)  // âš ï¸ n æ˜¯åŒä¸€å€‹è®Šé‡ï¼
		          })
		      }
		      
		      for _, f := range funcs {
		          f()
		      }
		  }
		  ```
		  
		  **è¼¸å‡ºï¼ˆGo 1.21ï¼‰ï¼š**
		  ```
		  3
		  3
		  3  â† å…¨éƒ¨éƒ½æ˜¯ 3ï¼
		  ```
		- Go 1.22 èµ·ï¼Œfor-range å¾ªç’°è®Šé‡åœ¨æ¯æ¬¡è¿­ä»£éƒ½æ˜¯æ–°çš„ï¼
		  ```go
		  // Go 1.22+
		  func main() {
		      nums := []int{1, 2, 3}
		      var funcs []func()
		      
		      for _, n := range nums {
		          funcs = append(funcs, func() {
		              fmt.Println(n)  // âœ… ç¾åœ¨æ­£å¸¸äº†ï¼
		          })
		      }
		      
		      for _, f := range funcs {
		          f()
		      }
		  }
		  ```
		  
		  **è¼¸å‡ºï¼ˆGo 1.22+ï¼‰ï¼š**
		  ```
		  1
		  2
		  3  â† ç¬¦åˆé æœŸï¼
		  ```
			- goroutine ä¸­çš„é™·é˜±
			  ```go
			  // âŒ å³ä½¿åœ¨ Go 1.22ï¼Œé€™æ¨£ä¹Ÿæœ‰å•é¡Œ
			  for _, url := range urls {
			      go func() {
			          fetch(url)  // url æ˜¯å¤–éƒ¨è®Šé‡
			      }()
			  }
			  
			  // âœ… æ­£ç¢ºåšæ³•ï¼šä½œç‚ºåƒæ•¸å‚³å…¥
			  for _, url := range urls {
			      go func(u string) {
			          fetch(u)
			      }(url)
			  }
			  ```
			- æŒ‡é‡é™·é˜±
			  ```go
			  type User struct {
			      Name string
			  }
			  
			  users := []User{{"Alice"}, {"Bob"}}
			  var userPtrs []*User
			  
			  // âŒ å³ä½¿ Go 1.22 ä¹Ÿæœ‰å•é¡Œ
			  for _, u := range users {
			      userPtrs = append(userPtrs, &u)  // u çš„åœ°å€åœ¨æ¯æ¬¡è¿­ä»£æœƒè®Š
			  }
			  
			  // çµæœï¼šå¯èƒ½éƒ½æŒ‡å‘æœ€å¾Œä¸€å€‹å…ƒç´ 
			  
			  // âœ… æ­£ç¢ºåšæ³•
			  for i := range users {
			      userPtrs = append(userPtrs, &users[i])
			  }
			  ```
		- æª¢æ¸¬å·¥å…·
			- ä½¿ç”¨  `go vet`
			  ```
			  *# æœƒæª¢æ¸¬å¸¸è¦‹çš„é–‰åŒ…é™·é˜±*
			  go vet ./...
			  ```
			- ä½¿ç”¨éœæ…‹åˆ†æå·¥å…·
			  ```
			  go install github.com/nishanths/exhaustive/cmd/exhaustive@latest
			  exhaustive ./...
			  ```
- ## ErrGroup
  `errgroup` æ˜¯ Go å®˜æ–¹æ“´å±•åº«æä¾›çš„å·¥å…·ï¼Œç”¨æ–¼**ç®¡ç†ä¸€çµ„ goroutine çš„ç”Ÿå‘½é€±æœŸå’ŒéŒ¯èª¤è™•ç†**ã€‚
  
  ```go
  import "golang.org/x/sync/errgroup"
  ```
	- **æ ¸å¿ƒåŠŸèƒ½ï¼š**
		- âœ… ç­‰å¾…ä¸€çµ„ goroutine å®Œæˆï¼ˆé¡ä¼¼ `sync.WaitGroup`ï¼‰
		- âœ… æ”¶é›†ç¬¬ä¸€å€‹éŒ¯èª¤ä¸¦å–æ¶ˆå…¶ä»– goroutine
		- âœ… è‡ªå‹•ç®¡ç† Context å–æ¶ˆ
	- WithContext
	  ```go
	  func fetchAllWithCancel(ctx context.Context, urls []string) error {
	      // å‰µå»ºå¸¶ Context çš„ ErrGroup
	      g, ctx := errgroup.WithContext(ctx)
	      
	      for _, url := range urls {
	          url := url
	          g.Go(func() error {
	              // ä½¿ç”¨ ctxï¼Œç•¶ä»»ä¸€ä»»å‹™å¤±æ•—æ™‚è‡ªå‹•å–æ¶ˆ
	              return fetchWithContext(ctx, url)
	          })
	      }
	      
	      return g.Wait()
	  }
	  
	  func fetchWithContext(ctx context.Context, url string) error {
	      req, _ := http.NewRequestWithContext(ctx, "GET", url, nil)
	      
	      resp, err := http.DefaultClient.Do(req)
	      if err != nil {
	          return fmt.Errorf("fetch %s failed: %w", url, err)
	      }
	      defer resp.Body.Close()
	      
	      // æª¢æŸ¥æ˜¯å¦è¢«å–æ¶ˆ
	      if ctx.Err() != nil {
	          return ctx.Err()
	      }
	      
	      // è™•ç†éŸ¿æ‡‰...
	      return nil
	  }
	  ```
	  
	  **å·¥ä½œåŸç†ï¼š**
	  ```
	  goroutine 1: âœ… æˆåŠŸ
	  goroutine 2: âŒ å¤±æ•— â†’ è§¸ç™¼ ctx.Cancel()
	  goroutine 3: ğŸ›‘ æª¢æ¸¬åˆ° ctx.Done()ï¼Œæå‰é€€å‡º
	  goroutine 4: ğŸ›‘ æª¢æ¸¬åˆ° ctx.Done()ï¼Œæå‰é€€å‡º
	  ```
- ## sync.Pool
  è‡¨æ™‚ç‰©ä»¶æ± ï¼Œä¸»è¦ç”¨ä¾†æ¸›å°‘ GC å£“åŠ›å’Œæå‡æ•ˆèƒ½ã€‚
	- ç‰¹æ€§
		- **è‡¨æ™‚æ€§**ï¼šPool è£¡çš„ç‰©ä»¶éš¨æ™‚å¯èƒ½è¢« GC å›æ”¶ï¼ˆä¸ä¿è­‰ä¸€å®šå­˜åœ¨ï¼‰
		- **ä½µç™¼å®‰å…¨**ï¼šå¤šå€‹ goroutine å¯ä»¥å®‰å…¨åœ°å­˜å–
		- **è‡ªå‹•æ¸…ç†**ï¼šGC æ™‚æœƒæ¸…ç©º Poolï¼ˆæ¯å…©æ¬¡ GC ä¹‹é–“æ¸…ä¸€æ¬¡ï¼‰
	- ### ç‚ºä»€éº¼éœ€è¦ sync.Pool
		- **æ¸›å°‘è¨˜æ†¶é«”åˆ†é…æ¬¡æ•¸**
		  ```go
		  // âŒ ä¸å¥½çš„åšæ³•ï¼šé »ç¹åˆ†é…è¨˜æ†¶é«”
		  func handleRequest() {
		      buf := make([]byte, 64*1024)  // æ¯æ¬¡éƒ½åˆ†é… 64KB
		      // ... ä½¿ç”¨ buf
		      // buf ç”¨å®Œå°±è¢«ä¸Ÿæ£„ â†’ GC å£“åŠ›å¤§
		  }
		  
		  // âœ… å¥½çš„åšæ³•ï¼šé‡è¤‡ä½¿ç”¨ç‰©ä»¶
		  var bufferPool = sync.Pool{
		      New: func() interface{} {
		          return make([]byte, 64*1024)
		      },
		  }
		  
		  func handleRequest() {
		      buf := bufferPool.Get().([]byte)
		      defer bufferPool.Put(buf)  // ç”¨å®Œæ”¾å›
		      // ... ä½¿ç”¨ buf
		  }
		  ```
		- **é™ä½ GC å£“åŠ›**
		- **æå‡æ•ˆèƒ½ï¼ˆç‰¹åˆ¥æ˜¯é«˜ä½µç™¼å ´æ™¯ï¼‰**
	- å¸¸ç”¨å ´æ™¯
		- Buffer Poolï¼ˆæœ€å¸¸è¦‹ï¼‰
		- æ ¼å¼åŒ–å·¥å…·ï¼ˆfmt.Sprintf å…§éƒ¨ç”¨æ³•ï¼‰
		- é€£ç·šæ± ç›¸é—œï¼ˆRedis, DBï¼‰
	- å¸¸è¦‹é™·é˜±
		- å¿˜è¨˜ Reset
		  ```go
		  // âŒ éŒ¯èª¤ï¼šä¸ reset
		  buf := bufferPool.Get().(*bytes.Buffer)
		  buf.WriteString("old data")
		  bufferPool.Put(buf)
		  
		  buf2 := bufferPool.Get().(*bytes.Buffer)
		  // buf2 å¯èƒ½åŒ…å« "old data"ï¼
		  
		  // âœ… æ­£ç¢ºï¼šä½¿ç”¨å‰ reset
		  buf := bufferPool.Get().(*bytes.Buffer)
		  buf.Reset()  // æ¸…ç©ºèˆŠè³‡æ–™
		  buf.WriteString("new data")
		  ```
		- æŠŠ Pool ç•¶æ°¸ä¹…å„²å­˜ **sync.Pool åœ¨ GC ç™¼ç”Ÿæ™‚æœƒè¢«æ¸…ç©º**
		  ```go
		  // âŒ éŒ¯èª¤ï¼šæœŸå¾…ç‰©ä»¶æ°¸é å­˜åœ¨
		  pool.Put(importantData)
		  // GC ç™¼ç”Ÿ...
		  data := pool.Get()  // å¯èƒ½æ˜¯ nilï¼
		  ```
		- Pool è£¡å­˜äº†å¸¶ç‹€æ…‹çš„ç‰©ä»¶
- ## sync.Once
  ä¿è­‰æŸå€‹å‡½æ•¸åœ¨ä½µç™¼ç’°å¢ƒä¸‹åªåŸ·è¡Œä¸€æ¬¡
	- **åŸ·è¡Œä¸€æ¬¡**ï¼šç„¡è«–å¤šå°‘å€‹ goroutine åŒæ™‚å‘¼å«ï¼Œå‡½æ•¸åªæœƒè¢«åŸ·è¡Œä¸€æ¬¡
	- **ä½µç™¼å®‰å…¨**ï¼šå…§éƒ¨ä½¿ç”¨ atomic + mutex å¯¦ç¾
	- **é˜»å¡ç­‰å¾…**ï¼šç¬¬ä¸€å€‹ goroutine åŸ·è¡Œæ™‚ï¼Œå…¶ä»– goroutine æœƒç­‰å¾…å®ƒå®Œæˆ
- ## sync.Cond
  æ¢ä»¶è®Šæ•¸ï¼ˆCondition Variableï¼‰ï¼Œç”¨æ–¼ goroutine ä¹‹é–“çš„ç­‰å¾…/é€šçŸ¥æ©Ÿåˆ¶
	- ç‰¹æ€§
		- **ç­‰å¾…æ¢ä»¶**ï¼šgoroutine å¯ä»¥ç­‰å¾…æŸå€‹æ¢ä»¶æˆç«‹
		- **é€šçŸ¥æ©Ÿåˆ¶**ï¼šå…¶ä»– goroutine å¯ä»¥é€šçŸ¥ç­‰å¾…è€…æ¢ä»¶å·²æˆç«‹
		- **å¿…é ˆé…åˆé–**ï¼šæ‰€æœ‰æ“ä½œå¿…é ˆåœ¨æŒæœ‰ Mutex çš„æƒ…æ³ä¸‹é€²è¡Œ
	- ç‚ºä»€éº¼éœ€è¦ sync.Condï¼Ÿ
		- ä¸å¥½çš„åšæ³•ï¼šå¿™ç­‰å¾…ï¼ˆBusy-waitingï¼‰
		  ```go
		  var (
		      mu    sync.Mutex
		      ready bool
		  )
		  
		  // âŒ æµªè²» CPU
		  func waitForReady() {
		      for {
		          mu.Lock()
		          if ready {
		              mu.Unlock()
		              break
		          }
		          mu.Unlock()
		          time.Sleep(10 * time.Millisecond)  // è¼ªè©¢ï¼Œæµªè²» CPU
		      }
		      fmt.Println("æ¢ä»¶æˆç«‹ï¼Œç¹¼çºŒåŸ·è¡Œ")
		  }
		  ```
		- ä½¿ç”¨ sync.Condï¼šé«˜æ•ˆç­‰å¾…
		  ```go
		  var (
		      mu    sync.Mutex
		      cond  = sync.NewCond(&mu)
		      ready bool
		  )
		  
		  // âœ… é«˜æ•ˆï¼šé˜»å¡ç­‰å¾…ï¼Œä¸æµªè²» CPU
		  func waitForReady() {
		      mu.Lock()
		      for !ready {  // å¾ªç’°æª¢æŸ¥æ¢ä»¶
		          cond.Wait()  // é‡‹æ”¾é–ä¸¦é˜»å¡ï¼Œç­‰å¾…è¢«å–šé†’
		      }
		      mu.Unlock()
		      fmt.Println("æ¢ä»¶æˆç«‹ï¼Œç¹¼çºŒåŸ·è¡Œ")
		  }
		  
		  func setReady() {
		      mu.Lock()
		      ready = true
		      cond.Signal()  // å–šé†’ä¸€å€‹ç­‰å¾…çš„ goroutine
		      mu.Unlock()
		  }
		  ```
	- ä¸‰å€‹æ ¸å¿ƒæ–¹æ³•
		- Wait() - ç­‰å¾…
		  ```go
		  cond.Wait()
		  ```
		  
		  **åšäº†ä¸‰ä»¶äº‹ï¼š**
		  1. è‡ªå‹•é‡‹æ”¾é–ï¼ˆunlockï¼‰
		  2. é˜»å¡ç­‰å¾…ï¼ˆblockï¼‰
		  3. è¢«å–šé†’å¾Œï¼Œé‡æ–°ç²å¾—é–ï¼ˆlockï¼‰
		  
		  **åŸ·è¡Œæµç¨‹ï¼š**
		  ```
		  goroutine æŒæœ‰é–
		      â†“
		  å‘¼å« cond.Wait()
		      â†“
		  è‡ªå‹•é‡‹æ”¾é–ï¼ˆå…¶ä»– goroutine å¯ä»¥é€²ä¾†ï¼‰
		      â†“
		  é˜»å¡ç­‰å¾…...
		      â†“
		  è¢« Signal/Broadcast å–šé†’
		      â†“
		  è‡ªå‹•é‡æ–°ç²å¾—é–
		      â†“
		  å¾ Wait() è¿”å›
		  ```
		- Signal() - å–šé†’ä¸€å€‹
		  ```go
		  ```
		- Broadcast() - å–šé†’æ‰€æœ‰
		  ```go
		  ```
- ## Reference
	- , "Go è¯­è¨€é«˜æ€§èƒ½ç¼–ç¨‹," *geektutu.com*, Available: [link_to_page](https://geektutu.com/post/high-performance-go.html). 
	  type:: [[Web Page]]